<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>E-mail Testing with Mock SMTP Server | Maciek's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/technology/>Tech</a></li><li><a href=/travel/>Travel</a></li><li><a href=/cooking/>Cook</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>E-mail Testing with Mock SMTP Server</span></h1></div><main><p>If our application can send e-mail (and, according to <a href=http://www.natpryce.com/articles/000749.html>Letts’ Law</a>, it eventually will), we would want our <a href=https://blog.mmakowski.com/technology/integration-testing-with-teamcity/>integration tests</a> to verify that the e-mail has indeed been sent, and that its contents are as expected. If we have written the integration tests in Python this will be pretty straightforward: Python library provides <code>smtpd</code> package with an implementation of SMTP server class, all we need to do is extend it to store the received messages and provide a way for the test code to verify that message has indeed been received. The Mock server class presented below runs in a separate thread and can be started and interrogated from existing test scripts.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#d14>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d14>Provides a mock SMTP server implementation, MockSMTPServer.
</span></span></span><span style=display:flex><span><span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14>Sample usage:
</span></span></span><span style=display:flex><span><span style=color:#d14>----
</span></span></span><span style=display:flex><span><span style=color:#d14># create the server -- will start automatically
</span></span></span><span style=display:flex><span><span style=color:#d14>import smtpmock
</span></span></span><span style=display:flex><span><span style=color:#d14>mock_server = smtpmock.MockSMTPServer(&#34;localhost&#34;, 25025)
</span></span></span><span style=display:flex><span><span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14>#send a test message
</span></span></span><span style=display:flex><span><span style=color:#d14>import smtplib
</span></span></span><span style=display:flex><span><span style=color:#d14>client = smtplib.SMTP(&#34;localhost&#34;, 25025)
</span></span></span><span style=display:flex><span><span style=color:#d14>fromaddr = &#34;test.sender@mydomain.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>toaddrs = [&#34;test.recipient1@mydomain.com&#34;, &#34;test.recipient2@mydomain.com&#34;]
</span></span></span><span style=display:flex><span><span style=color:#d14>content = &#34;test message content&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>msg = &#34;From: </span><span style=color:#d14>%s</span><span style=color:#d14>\r\n</span><span style=color:#d14>To: </span><span style=color:#d14>%s</span><span style=color:#d14>\r\n\r\n</span><span style=color:#d14>%s</span><span style=color:#d14>&#34; % (fromaddr, &#34;, &#34;.join(toaddrs), content)
</span></span></span><span style=display:flex><span><span style=color:#d14>client.sendmail(fromaddr, toaddrs, msg)
</span></span></span><span style=display:flex><span><span style=color:#d14>client.quit()
</span></span></span><span style=display:flex><span><span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14># verify that the message has been recieved
</span></span></span><span style=display:flex><span><span style=color:#d14>assert(mock_server.received_message_matching(&#34;From: .*</span><span style=color:#d14>\\</span><span style=color:#d14>nTo: .*</span><span style=color:#d14>\\</span><span style=color:#d14>n+.+tent&#34;))
</span></span></span><span style=display:flex><span><span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14># reset the server to be ready for a new test
</span></span></span><span style=display:flex><span><span style=color:#d14>mock_server.reset()
</span></span></span><span style=display:flex><span><span style=color:#d14>assert(mock_server.received_messages_count() == 0)
</span></span></span><span style=display:flex><span><span style=color:#d14>----
</span></span></span><span style=display:flex><span><span style=color:#d14>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>asyncore</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>re</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>smtpd</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>threading</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>MockSMTPServer</span>(smtpd<span style=color:#000;font-weight:700>.</span>SMTPServer, threading<span style=color:#000;font-weight:700>.</span>Thread):
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d14>    A mock SMTP server. Runs in a separate thread so can be started from
</span></span></span><span style=display:flex><span><span style=color:#d14>    existing test code.
</span></span></span><span style=display:flex><span><span style=color:#d14>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> __init__(<span style=color:#999>self</span>, hostname, port):
</span></span><span style=display:flex><span>        threading<span style=color:#000;font-weight:700>.</span>Thread<span style=color:#000;font-weight:700>.</span>__init__(<span style=color:#999>self</span>)
</span></span><span style=display:flex><span>        smtpd<span style=color:#000;font-weight:700>.</span>SMTPServer<span style=color:#000;font-weight:700>.</span>__init__(<span style=color:#999>self</span>, (hostname, port), <span style=color:#000;font-weight:700>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>daemon <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>True</span>
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>received_messages <span style=color:#000;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>run</span>(<span style=color:#999>self</span>):
</span></span><span style=display:flex><span>        asyncore<span style=color:#000;font-weight:700>.</span>loop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>process_message</span>(<span style=color:#999>self</span>, peer, mailfrom, rcpttos, data):
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>received_messages<span style=color:#000;font-weight:700>.</span>append(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>reset</span>(<span style=color:#999>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>received_messages <span style=color:#000;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># helper methods for assertions in test cases</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>received_message_matching</span>(<span style=color:#999>self</span>, template):
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>for</span> message <span style=color:#000;font-weight:700>in</span> <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>received_messages:
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> re<span style=color:#000;font-weight:700>.</span>match(template, message): <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>True</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>received_messages_count</span>(<span style=color:#999>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>len</span>(<span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>received_messages)
</span></span></code></pre></div></main><p class=date>20/08/2010</p><footer><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><hr>© Maciek Makowski 2010 &ndash; 2023. Content licensed under <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></footer></body></html>