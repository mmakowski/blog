<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scala Futures on a Single Thread | Maciek's blog</title><link rel=stylesheet href=/blog/css/style.css><link rel=stylesheet href=/blog/css/fonts.css></head><body><nav><ul class=menu><li><a href=/blog/technology/>Tech</a></li><li><a href=/blog/travel/>Travel</a></li><li><a href=/blog/cooking/>Cook</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Scala Futures on a Single Thread</span></h1></div><main><p><a href=http://docs.scala-lang.org/sips/pending/futures-promises.html>Futures</a>, introduced into Scala standard library in version 2.10, quickly became one of the cornerstones of Scala concurrency. Their main selling point is the ease of composition. A standard example of that involves asynchronous calls to a number of remote services and computation of the answer once all of the responses are collected:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> price<span style=color:#000;font-weight:700>(</span>itemId<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Id</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Future</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Price</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>???</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> availability<span style=color:#000;font-weight:700>(</span>itemId<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Id</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Future</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>???</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> orderQuote<span style=color:#000;font-weight:700>(</span>itemId<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Id</span><span style=color:#000;font-weight:700>,</span> quantityRequired<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Future</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Option</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Price</span><span style=color:#000;font-weight:700>]]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  unitPrice         <span style=color:#000;font-weight:700>&lt;-</span> price<span style=color:#000;font-weight:700>(</span>itemId<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  quantityAvailable <span style=color:#000;font-weight:700>&lt;-</span> availability<span style=color:#000;font-weight:700>(</span>itemId<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>yield</span> <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>quantityAvailable <span style=color:#000;font-weight:700>&gt;=</span> quantityRequired<span style=color:#000;font-weight:700>)</span> <span style=color:#458;font-weight:700>Some</span><span style=color:#000;font-weight:700>(</span>quantityRequired <span style=color:#000;font-weight:700>*</span> unitPrice<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#458;font-weight:700>None</span>
</span></span></code></pre></div><p>Here <code>price</code> and <code>availability</code> are service calls that can potentially take long time and are meant to be executed in parallel.</p><p>However, the usefulness of futures is not restricted to the concurrent setting. They also provide a nice pattern for suspending execution of a sequential algorithm until a certain condition is met. There is nothing inherently concurrent about <code>Future</code> implementation either – the runtime behaviour depends on the instance of <a href=http://www.scala-lang.org/api/current/index.html#scala.concurrent.ExecutionContext><code>ExecutionContext</code></a> provided to functions that can spawn new computations.</p><p>The example below illustrates how futures and promises facilitate suspension of effects until the required condition – the availability of price in this case – is met.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.concurrent.Executor</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>scala.collection.mutable</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>scala.concurrent._</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>scala.util.</span><span style=color:#000;font-weight:700>{</span><span style=color:#458;font-weight:700>Success</span><span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>Failure</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// thanks to being implicit this execution context will be used by all Future methods that
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// can spawn new Futures, making all spawned computations synchronous
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>implicit</span> <span style=color:#000;font-weight:700>val</span> synchronousExecutionContext <span style=color:#000;font-weight:700>=</span> <span style=color:#458;font-weight:700>ExecutionContext</span><span style=color:#000;font-weight:700>.</span>fromExecutor<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>new</span> <span style=color:#458;font-weight:700>Executor</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>def</span> execute<span style=color:#000;font-weight:700>(</span>task<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Runnable</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>=</span> task<span style=color:#000;font-weight:700>.</span>run<span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>object</span> <span style=color:#458;font-weight:700>PriceService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>val</span> prices <span style=color:#000;font-weight:700>=</span> mutable<span style=color:#000;font-weight:700>.</span><span style=color:#458;font-weight:700>HashMap</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>String</span>, <span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>]()</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>val</span> pendingRequests <span style=color:#000;font-weight:700>=</span> mutable<span style=color:#000;font-weight:700>.</span><span style=color:#458;font-weight:700>HashMap</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>String</span>, <span style=color:#458;font-weight:700>Set</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Promise</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>]]]()</span> withDefaultValue <span style=color:#458;font-weight:700>Set</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>def</span> setPrice<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>String</span><span style=color:#000;font-weight:700>,</span> price<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Unit</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    prices <span style=color:#000;font-weight:700>+=</span> <span style=color:#000;font-weight:700>(</span>symbol <span style=color:#000;font-weight:700>-&gt;</span> price<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    println<span style=color:#000;font-weight:700>(</span><span style=color:#d14>s&#34;</span><span style=color:#d14>${</span><span style=color:#458;font-weight:700>Thread</span><span style=color:#000;font-weight:700>.</span>currentThread<span style=color:#000;font-weight:700>.</span>getName<span style=color:#d14>}</span><span style=color:#d14>: price received: </span><span style=color:#d14>$symbol</span><span style=color:#d14>: </span><span style=color:#d14>$price</span><span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pendingRequests<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>).</span>foreach<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>_</span><span style=color:#000;font-weight:700>.</span>success<span style=color:#000;font-weight:700>(</span>price<span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>def</span> price<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Future</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>prices<span style=color:#000;font-weight:700>.</span>contains<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>))</span> <span style=color:#458;font-weight:700>Future</span><span style=color:#000;font-weight:700>.</span>successful<span style=color:#000;font-weight:700>(</span>prices<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>val</span> request <span style=color:#000;font-weight:700>=</span> <span style=color:#458;font-weight:700>Promise</span><span style=color:#000;font-weight:700>[</span><span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>]()</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>val</span> updatedRequests <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>pendingRequests<span style=color:#000;font-weight:700>.</span>contains<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>))</span> pendingRequests<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>+</span> request
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>else</span>                                  <span style=color:#458;font-weight:700>Set</span><span style=color:#000;font-weight:700>(</span>request<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      pendingRequests <span style=color:#000;font-weight:700>+=</span> <span style=color:#000;font-weight:700>(</span>symbol <span style=color:#000;font-weight:700>-&gt;</span> updatedRequests<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      request<span style=color:#000;font-weight:700>.</span>future
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> publishValuation<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>String</span><span style=color:#000;font-weight:700>,</span> quantity<span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Int</span><span style=color:#000;font-weight:700>)</span><span style=color:#000;font-weight:700>:</span> <span style=color:#458;font-weight:700>Unit</span> <span style=color:#000;font-weight:700>=</span>
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>PriceService</span><span style=color:#000;font-weight:700>.</span>price<span style=color:#000;font-weight:700>(</span>symbol<span style=color:#000;font-weight:700>).</span>map<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>_</span> <span style=color:#000;font-weight:700>*</span> quantity<span style=color:#000;font-weight:700>).</span>onComplete <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#458;font-weight:700>Success</span><span style=color:#000;font-weight:700>(</span>value<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>=&gt;</span> println<span style=color:#000;font-weight:700>(</span><span style=color:#d14>s&#34;</span><span style=color:#d14>${</span><span style=color:#458;font-weight:700>Thread</span><span style=color:#000;font-weight:700>.</span>currentThread<span style=color:#000;font-weight:700>.</span>getName<span style=color:#d14>}</span><span style=color:#d14>: </span><span style=color:#d14>$quantity</span><span style=color:#d14> x </span><span style=color:#d14>$symbol</span><span style=color:#d14>: </span><span style=color:#d14>$value</span><span style=color:#d14>)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#458;font-weight:700>Failure</span><span style=color:#000;font-weight:700>(</span>e<span style=color:#000;font-weight:700>)</span>     <span style=color:#000;font-weight:700>=&gt;</span> println<span style=color:#000;font-weight:700>(</span><span style=color:#d14>s&#34;error: </span><span style=color:#d14>$e</span><span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>PriceService</span><span style=color:#000;font-weight:700>.</span>setPrice<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;AAA&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#099>1013</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>publishValuation<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;AAA&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#099>20</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>publishValuation<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;BBB&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#099>30</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>PriceService</span><span style=color:#000;font-weight:700>.</span>setPrice<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;BBB&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#099>221</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>This code prints out:</p><pre tabindex=0><code>main: price received: AAA: 1013
main: 20 x AAA: 20260)
main: price received: BBB: 221
main: 30 x BBB: 6630)
</code></pre><p>demonstrating that unfulfilled condition doesn’t block the program even though only a single thread is used – and all that happens without breaking the abstraction boundaries between <code>PriceService</code> and the valuation publishing code.</p></main><p class=date>05/10/2013</p><footer><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><hr>© Maciek Makowski 2010 &ndash; 2022. Content licensed under <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></footer></body></html>