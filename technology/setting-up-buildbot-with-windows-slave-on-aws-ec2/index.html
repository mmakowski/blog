<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Setting up BuildBot with Windows Slave on AWS EC2 | Maciek's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/blog/technology/>Tech</a></li><li><a href=/blog/travel/>Travel</a></li><li><a href=/blog/cooking/>Cook</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Setting up BuildBot with Windows Slave on AWS EC2</span></h1><h2 class=date>2011/08/15</h2></div><main><p>Not long ago I set up a BuildBot instance for wxHaskell and thought about sharing my experience with configuring all the elements of the system. Johan Tibell’s <a href=http://blog.johantibell.com/2011/08/results-from-state-of-haskell-2011.html>commentary to the State of Haskell, 2011 survey</a>, and his call for Windows bots to test Hackage libraries, prompted me to finally put my notes together into tutorial of a sort. There is nothing Haskell-specific, so if you are looking to automate Windows builds of apps written in any other language this guide should provide all the info you need.</p><h2 id=the-setup>The Setup</h2><p><a href=http://trac.buildbot.net>BuildBot</a> is a build server designed specifically for automating builds of software that targets multiple platforms. The central server (master) sends build requests to multiple slaves, each of which can be configured differently. The server receives the build results from slaves, aggregates them and displays via a web interface. While the server should be accessible at all times, the slaves are only required when there is something to build.</p><p>In order for the build to be repeatable and to avoid random errors introduced by unrelated configuration changes, it would be nice for the slaves to be dedicated machines with a known initial configurations. This sounds like an ideal setting for using virual servers created from a disk image specifically for the build. Thanks to services like Amazon EC2 it is relatively easy and inexpensive to set up such a box.</p><p>Helpfully, BuildBot supports so called “latent slaves”, which are started by the server when there is a build to run, and are stopped when there is no more work to do. Furthermore, there is an implementation of a latent slave that works with EC2.</p><h2 id=what-we-will-need>What we will need</h2><p>For the BuildBot master, we’ll need a server with shell access, which is permanently online and where you can open a port to a non-HTTP traffic (this is required for accepting slave connections). I’ve used a <a href=http://webfaction.com>WebFaction</a> shared hosting with a dedicated IP (additional 5$ per month), which is required for the aforementioned port.</p><p>We’ll set up the slave on Amazon EC2. I’m not going to cover how to set up an account there as the process is straightforward and there are numerous resources on how to do this. Hosting of the disk image (AMI) will set us back a couple of dollars per month; on top of that we’ll need to pay for the time our slave is running, which for typical builds that take less than an hour and one build every day running on a micro instance will add another couple of dollars.</p><h2 id=the-master>The Master</h2><p>All of the steps below happen on the always-online server. They assume that <code>python</code> on our server runs Python version 2.7.</p><h3 id=virtualenv>Virtualenv</h3><p>Download the tarball from [http://pypi.python.org/pypi/virtualenv/] and untar to a temporary directory. In there run <code>python setup.py instal --dry-run</code>. If it complains about missing directories, create them. Continue running with –dry-run until it passe, then run without –dry-run. Once done, we should end up with <code>virtualenv</code> script in <code>~/bin</code>. We can then get rid of the tarball and temporary directory.</p><h3 id=buildbot>BuildBot</h3><p>Follow the <a href=http://buildbot.net/buildbot/docs/current/tutorial/firstrun.html#creating-a-master>BuildBot tutorial</a>. I installed BuildBot in <code>~/opt/buildbot</code> instead of suggested <code>~/tmp/buildbot</code>, other than that I followed it to the letter.</p><p>Opening the BuildBot website to the outside world depends on how our server is set up. For WebFaction it involved creating a custom web application via the control panel. This web application got assigned a port number, which then needed to be set in BuildBot’s config by editing <code>~/opt/buildbot/sandbox/master/master.cfg</code> and changing the <code>http_port</code> in <code>c['status'].append(html.WebStatus(http_port=8010, authz=authz_cfg))</code> to the assigned port.</p><p>Finally, we might want to set up a cron job to automatically start the master should it die for any reason; here’s the script I used:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># starts the buildbot master if it&#39;s not running already</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>HOME</span><span style=color:#000;font-weight:700>=</span>/home/mmakowski
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ps -ef | grep <span style=color:#d14>&#39;buildbot start master&#39;</span> | grep -vq grep
</span></span><span style=display:flex><span><span style=color:teal>RUNNING</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$RUNNING</span> -ne <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>cd</span> <span style=color:teal>$HOME</span>/opt/buildbot
</span></span><span style=display:flex><span>    <span style=color:#0086b3>source</span> sandbox/bin/activate
</span></span><span style=display:flex><span>    <span style=color:#0086b3>cd</span> sandbox
</span></span><span style=display:flex><span>    buildbot start master
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span></code></pre></div><p>Then <code>crontab -e</code> and add entry:</p><pre tabindex=0><code>0       *       *       *       *       /home/mmakowski/bin/buildbot-start-master-if-not-running &amp;
</code></pre><p>which will ensure that the script will run once every hour.</p><h2 id=the-slave>The Slave</h2><p>If we have a Windows box handy we might want to test the slave setup on it before playing with AWS instance, which is billed by the hour.</p><p>Log on to <a href=https://console.aws.amazon.com/ec2>AWS Management Console</a> and set up a Windows instance using one of the Windows AMIs provided by Amazon((I’ll assume we used a 64-bit OS in the instructions that follow; if not, 32 bit versions of relevant software should be used instead of the ones mentioned)) (see <a href=http://docs.amazonwebservices.com/AWSEC2/latest/GettingStartedGuide/>EC2 Gettings Started guide</a> for step-by-step instructions). After a couple of minutes we will be able to retrieve the administrator password and connect using Remote Desktop Connection (if on Windows) or rdesktop (on Linux or Mac).</p><p>Once logged on, we need to change the administrator password to something we’ll remember and install the following software:</p><ul><li><a href=http://www.python.org/getit/releases/2.7/>Python 2.7</a> (64 bit)</li><li><a href=http://sourceforge.net/projects/pywin32/files/pywin32/>Pywin32</a></li><li><a href=http://pypi.python.org/pypi/setuptools#windows>easy_install</a></li><li><a href=http://twistedmatrix.com/trac/wiki/Downloads>Twisted</a></li><li>Using easy_install set up <code>zope.interface</code>: <code>easy_install zope.interface</code></li><li>unzip <a href=http://code.google.com/p/buildbot/downloads/list>BuildBot Slave</a> to a temporary directory and run <code>setup.py install</code> in there</li></ul><p>On top of that we will need to install any other software required to build the project we’re setting the slave up for (VCS client, compiler, libraries etc.)</p><p>Once it is done, we can follow <a href=http://buildbot.net/buildbot/docs/current/tutorial/firstrun.html#creating-a-slave>the slave part of the BuildBot tutorial</a> to make sure that the slave can communicate with the master and can handle build requests.</p><p>Note that so far the slave we set up is a regular (non-latent) one, i.e. master will assume that it is always online and available to handle build requests. We’ll address this shortly; for now it’s important to make sure that the builds work as expected on our newly set up server.</p><h2 id=making-it-latent>Making it Latent</h2><h3 id=the-slave-1>The Slave</h3><p>After we are happy that the master can invoke builds, one final piece of slave configuration is ensuring that the slave process starts up automatically after the server is brought on line; on Windows this is done using services. Making slave run as a service will require a piece of custom Python code. I’ve used <a href=http://nyc-dba.blogspot.com/2008/10/running-buildbot-buildslave-as-windows.html>the script by Ira Pfeifer</a>, modified slightly to work with recent version of BuildBot. Here it is, for your convenience; make sure to update the environment variables set in the script to contain everything your build needs:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#d14>&#34;&#34;&#34; buildbot_slave_service.py
</span></span></span><span style=display:flex><span><span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14>Original Author: Ira Pfeifer
</span></span></span><span style=display:flex><span><span style=color:#d14>Email: ipfeifer -dot- tech -at- gmail
</span></span></span><span style=display:flex><span><span style=color:#d14>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>sys</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>os</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>subprocess</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>win32serviceutil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>win32service</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>win32event</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>win32api</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>buildslave.scripts</span> <span style=color:#000;font-weight:700>import</span> runner
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>buildslave.scripts.startup</span> <span style=color:#000;font-weight:700>import</span> start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># change paths as appropriate</span>
</span></span><span style=display:flex><span>slavepath <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;c:</span><span style=color:#d14>\\</span><span style=color:#d14>buildbot</span><span style=color:#d14>\\</span><span style=color:#d14>slave-wxhaskell&#34;</span>
</span></span><span style=display:flex><span>homepath <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;</span><span style=color:#d14>\\</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>os<span style=color:#000;font-weight:700>.</span>environ[<span style=color:#d14>&#39;HOMEDRIVE&#39;</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;C:&#34;</span>
</span></span><span style=display:flex><span>os<span style=color:#000;font-weight:700>.</span>environ[<span style=color:#d14>&#39;HOMEPATH&#39;</span>] <span style=color:#000;font-weight:700>=</span> homepath
</span></span><span style=display:flex><span>os<span style=color:#000;font-weight:700>.</span>environ[<span style=color:#d14>&#39;PATH&#39;</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>r</span><span style=color:#d14>&#34;C:\Python27;C:\Python27\Scripts;C:\Program Files (x86)\Haskell\bin;C:\Program Files (x86)\Haskell Platform\2011.2.0.1\lib\extralibs\bin;C:\Program Files (x86)\Haskell Platform\2011.2.0.1\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;c:\program files (x86)\wx-config;c:\program files (x86)\Darcs;C:\Users\Administrator\AppData\Roaming\cabal\bin&#34;</span>
</span></span><span style=display:flex><span>os<span style=color:#000;font-weight:700>.</span>environ[<span style=color:#d14>&#39;WXWIN&#39;</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>r</span><span style=color:#d14>&#34;C:\wxWidgets2.8&#34;</span>
</span></span><span style=display:flex><span>os<span style=color:#000;font-weight:700>.</span>environ[<span style=color:#d14>&#39;WXCFG&#39;</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>r</span><span style=color:#d14>&#34;gcc_dll\mswu&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>BuildSlaveService</span>(win32serviceutil<span style=color:#000;font-weight:700>.</span>ServiceFramework):
</span></span><span style=display:flex><span>    _svc_name_ <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;BuildBot_Slave_wxHaskell&#34;</span>
</span></span><span style=display:flex><span>    _svc_display_name_ <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;BuildBot Slave wxHaskell&#34;</span>
</span></span><span style=display:flex><span>    _svc_description_ <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;Buildbot slave based in &#34;</span> <span style=color:#000;font-weight:700>+</span> slavepath
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> __init__(<span style=color:#999>self</span>, args):
</span></span><span style=display:flex><span>        win32serviceutil<span style=color:#000;font-weight:700>.</span>ServiceFramework<span style=color:#000;font-weight:700>.</span>__init__(<span style=color:#999>self</span>, args)
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>stop_event <span style=color:#000;font-weight:700>=</span> win32event<span style=color:#000;font-weight:700>.</span>CreateEvent(<span style=color:#000;font-weight:700>None</span>, <span style=color:#099>0</span>, <span style=color:#099>0</span>, <span style=color:#000;font-weight:700>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>SvcDoRun</span>(<span style=color:#999>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># The service starts a subprocess that will run the actual buildbot</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># so that it can be stopped by simply killing off the subprocess.</span>
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>child <span style=color:#000;font-weight:700>=</span> subprocess<span style=color:#000;font-weight:700>.</span>Popen([<span style=color:#d14>&#34;python&#34;</span>, __file__, <span style=color:#d14>&#34;start&#34;</span>])
</span></span><span style=display:flex><span>        isAlive <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>True</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>while</span> isAlive:
</span></span><span style=display:flex><span>            time<span style=color:#000;font-weight:700>.</span>sleep(<span style=color:#099>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>SvcStop</span>(<span style=color:#999>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>ReportServiceStatus(win32service<span style=color:#000;font-weight:700>.</span>SERVICE_STOP_PENDING)
</span></span><span style=display:flex><span>        handle <span style=color:#000;font-weight:700>=</span> win32api<span style=color:#000;font-weight:700>.</span>OpenProcess(<span style=color:#099>1</span>,<span style=color:#099>0</span>,<span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>child<span style=color:#000;font-weight:700>.</span>pid)
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># returns exit code - wrap w/ error handling?</span>
</span></span><span style=display:flex><span>        win32api<span style=color:#000;font-weight:700>.</span>TerminateProcess(handle, <span style=color:#099>0</span>)
</span></span><span style=display:flex><span>        win32api<span style=color:#000;font-weight:700>.</span>CloseHandle(handle)
</span></span><span style=display:flex><span>        isAlive <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>False</span>
</span></span><span style=display:flex><span>        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>ReportServiceStatus(win32service<span style=color:#000;font-weight:700>.</span>SERVICE_STOP_PENDING)
</span></span><span style=display:flex><span>        win32<span style=color:#000;font-weight:700>.</span>SetEvent(<span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>hWaitStop)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        SvcShutdown <span style=color:#000;font-weight:700>=</span> SvcStop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>start_buildslave</span>():
</span></span><span style=display:flex><span>    config <span style=color:#000;font-weight:700>=</span> runner<span style=color:#000;font-weight:700>.</span>Options()
</span></span><span style=display:flex><span>    config<span style=color:#000;font-weight:700>.</span>parseOptions([<span style=color:#d14>&#39;start&#39;</span>, slavepath])
</span></span><span style=display:flex><span>    so <span style=color:#000;font-weight:700>=</span> config<span style=color:#000;font-weight:700>.</span>subOptions
</span></span><span style=display:flex><span>    start(so)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> __name__ <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> <span style=color:#0086b3>len</span>(sys<span style=color:#000;font-weight:700>.</span>argv) <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#099>1</span> <span style=color:#000;font-weight:700>and</span> sys<span style=color:#000;font-weight:700>.</span>argv[<span style=color:#099>1</span>] <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#34;start&#34;</span>:
</span></span><span style=display:flex><span>        start_buildslave()
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>else</span>:
</span></span><span style=display:flex><span>        win32serviceutil<span style=color:#000;font-weight:700>.</span>HandleCommandLine(BuildSlaveService)
</span></span></code></pre></div><p>Put this somewhere on the server and run <code>buildbot_slave_service.py install</code>. Then go to Services application and change the startup to <code>run automatically (delayed start)</code>, as Administrator.</p><p>After this is done we are ready to take a snapshot of the servers hard drive, so that we can start clones later on. Once the AMI appears as <em>available</em> in AMIs section of the EC2 console we will terminate the instance we’ve just configured.</p><h3 id=the-master-1>The Master</h3><p>We’ll need one additional Python library to enable BuildBot master to control EC2 instances: <a href=http://code.google.com/p/boto/>boto</a>. On the master server, cd to <code>~/opt/buildbot</code>, activate the sandbox (<code>. sandbox/bin/activate</code>) and run <code>easy_install boto</code>.</p><p>It’s now time to tell master to treat our slave as latent. The setup is described in the <a href=http://buildbot.net/buildbot/docs/current/full.html#Amazon-Web-Services-Elastic-Compute-Cloud-_0028_0022AWS-EC2_0022_0029>BuildBot docs</a>, and it boils down to updating <code>c['slaves']</code> like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#998;font-style:italic>####### BUILDSLAVES</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># The &#39;slaves&#39; list defines the set of recognized buildslaves. Each element is</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># a BuildSlave object, specifying a unique slave name and password.  The same</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># slave name and password must be configured on the slave.</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>buildbot.buildslave</span> <span style=color:#000;font-weight:700>import</span> BuildSlave
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>buildbot.ec2buildslave</span> <span style=color:#000;font-weight:700>import</span> EC2LatentBuildSlave
</span></span><span style=display:flex><span>c[<span style=color:#d14>&#39;slaves&#39;</span>] <span style=color:#000;font-weight:700>=</span> [EC2LatentBuildSlave(<span style=color:#d14>&#39;&lt;slave name&gt;&#39;</span>, <span style=color:#d14>&#39;&lt;slave password&gt;&#39;</span>, <span style=color:#d14>&#39;t1.micro&#39;</span>,
</span></span><span style=display:flex><span>                                   region<span style=color:#000;font-weight:700>=</span><span style=color:#d14>u</span><span style=color:#d14>&#39;eu-west-1&#39;</span>,
</span></span><span style=display:flex><span>                                   ami<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;ami-12345678&#39;</span>,
</span></span><span style=display:flex><span>                                   identifier<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;&lt;key identifier&gt;&#39;</span>,
</span></span><span style=display:flex><span>                                   secret_identifier<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;&lt;secret key&gt;&#39;</span>)]
</span></span></code></pre></div><p>Where:</p><ul><li><code>&lt;slave name></code> and <code>&lt;slave password></code> are the same as the ones we used so far</li><li><code>t1.micro</code> is the type of EC2 instance; change it to a bigger one if that’s what you require for your build (check <a href=http://aws.amazon.com/ec2/pricing/>the prices</a> before doing that though)</li><li><code>region</code> should be the region where you set up your AMI (can be seen in the AWS console)</li><li><code>ami-12345678</code> is the id of the AMI we have created from the slave instance</li><li><code>&lt;key identifier></code> and <code>&lt;secret key></code> can be generated and obtained from the <em>Security Credentials</em> section of your <a href=http://aws.amazon.com/account/>AWS account</a>.</li></ul><p>Finally, in BuildBot 0.8.4 there is an <a href=http://trac.buildbot.net/ticket/1931>issue with EC2 instances not being terminated</a>. If left unfixed it can lead to each build’s disk image being left active indefinitely and charging to our account! The bug should be fixed in BuildBot 0.8.5; in the mean time we can patch it by hand, by replacing <code>instance.stop()</code> with <code>instance.terminate()</code> in <code>~/opt/buildbot/sandbox/lib/python2.7/site-packages/buildbot-0.8.4p2-py2.7.egg/buildbot/ec2buildslave.py</code>.</p><p>Once this is done, a <code>buildbot restart master</code> should provide us with a BuildBot process running with the final set up and starting up EC2 slave when required.</p><h3 id=fixing-the-slave>Fixing the Slave</h3><p>If it turns out that our slave configuration needs an update, here is what we do:</p><ul><li>in AWS console, create a new instance using our slave AMI</li><li>connect to the instance using Remote Desktop Connection/rdesktop and make the necessary config changes</li><li>create a new AMI from the reconfigured instance and then termiante the instance</li><li>update the master config with the new AMI id</li></ul><h3 id=debugging-the-master>Debugging the Master</h3><p>While the source code of BuildBot might be a bit difficult to follow for someone not versed in Twisted, I found the <a href=http://buildbot.net/buildbot/docs/current/tutorial/tour.html#debugging-with-manhole>manhole interface</a> invaluable in tracking down what turned out to be a trivial config issue.</p><h2 id=gotchas>Gotchas</h2><p>Two things I got bitten by and which took a little bit to investigate and fix are:</p><ul><li>AWS instance reboot on startup. The Windows box is rebooted by AWS immediately after being started; apparently this is required for some TCP/IP-related reconfiguration to take effect. As a result it is crucial that our BuildBot slave service is set up with <strong>delayed start</strong>. Otherwise the service will start and report to the master; it can even start running the build, when suddenly the server will reboot. After the reboot the service will come back up and try to connect again, but the master will reject this connection as unsolicited.</li><li>The <code>instance.stop()</code> issue mentioned earlier. Strangely, I would swear that my setup had been working for about a week without any patches, with instances being terminated; the “orphaned” stopped instances seemed to have started appearing suddenly and without any changes in either the slave or the server code or config. I can only assume I must have been seeing things, since <code>instance.stop()</code> has been there all the time and I’d never expect it to terminate an instance.</li></ul><p>Hopefully you won’t come across any more nasty surprises. Happy building!</p></main><footer><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><hr>© Maciek Makowski 2010 &ndash; 2022. Content licensed under <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></footer></body></html>